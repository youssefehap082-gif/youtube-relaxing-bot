name: Auto Upload Relaxing Shorts (4/day)

on:
  schedule:
    - cron: '0 11 * * *'  # 11:00 UTC
    - cron: '0 17 * * *'  # 17:00 UTC
    - cron: '0 23 * * *'  # 23:00 UTC
    - cron: '0 05 * * *'  # 05:00 UTC
  workflow_dispatch:

jobs:
  upload_shorts:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl ffmpeg

      - name: Prepare workspace
        run: |
          rm -rf clips_short out_short || true
          mkdir -p clips_short out_short

      - name: Fetch short clip (Pexels -> Pixabay -> Coverr)
        env:
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
          COVERR_API_KEY: ${{ secrets.COVERR_API_KEY }}
        run: |
          set -e
          TOPICS=("rain" "ocean" "forest" "waterfall" "nature" "waves" "clouds" "desert")
          QUERY=${TOPICS[$RANDOM % ${#TOPICS[@]}]}
          echo "Query: $QUERY"

          # Pexels
          PEX=$(curl -s -H "Authorization: $PEXELS_API_KEY" "https://api.pexels.com/videos/search?query=$QUERY&per_page=15")
          CNT=$(echo "$PEX" | jq '.videos | length')
          URL=""
          if [ "$CNT" -gt 0 ]; then
            IDX=$((RANDOM % CNT))
            URL=$(echo "$PEX" | jq -r ".videos[$IDX].video_files[] | select(.width<=720) | .link" | head -n1)
          fi

          # Pixabay fallback
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            if [ -n "$PIXABAY_API_KEY" ]; then
              PB=$(curl -s "https://pixabay.com/api/videos/?key=$PIXABAY_API_KEY&q=$QUERY&per_page=20")
              CNT2=$(echo "$PB" | jq '.hits | length')
              if [ "$CNT2" -gt 0 ]; then
                IDX=$((RANDOM % CNT2))
                URL=$(echo "$PB" | jq -r ".hits[$IDX].videos.tiny.url")
              fi
            fi
          fi

          # Coverr fallback
          if ([ -z "$URL" ] || [ "$URL" = "null" ]) && [ -n "$COVERR_API_KEY" ]; then
            CV=$(curl -s -H "Authorization: Bearer $COVERR_API_KEY" "https://api.coverr.co/videos?per_page=10")
            URL=$(echo "$CV" | jq -r '.data[0].assets[0].url')
          fi

          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "No short clip found" >&2
            exit 1
          fi

          echo "Downloading short: $URL"
          curl -L "$URL" -o clips_short/clip_raw.mp4

          # Cut or loop to 45 seconds
          ffmpeg -y -i clips_short/clip_raw.mp4 -t 45 -c copy clips_short/short.mp4 || ffmpeg -y -ss 0 -i clips_short/clip_raw.mp4 -t 45 -c copy clips_short/short.mp4

      - name: Ensure audio for short (Pixabay preferred)
        env:
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
          MIXKIT_FALLBACK_AUDIO: ${{ secrets.MIXKIT_FALLBACK_AUDIO }}
        run: |
          set -e
          if ! ffmpeg -i clips_short/short.mp4 -af "volumedetect" -f null /dev/null 2>&1 | grep -q "mean_volume"; then
            echo "No audio in short -> try get audio from Pixabay video"
            if [ -n "$PIXABAY_API_KEY" ]; then
              PB=$(curl -s "https://pixabay.com/api/videos/?key=$PIXABAY_API_KEY&q=rain&per_page=20")
              CNT=$(echo "$PB" | jq '.hits | length')
              if [ "$CNT" -gt 0 ]; then
                IDX=$((RANDOM % CNT))
                URL=$(echo "$PB" | jq -r ".hits[$IDX].videos.tiny.url")
                curl -L "$URL" -o bg_video.mp4 || true
                if [ -f bg_video.mp4 ]; then
                  ffmpeg -y -i bg_video.mp4 -vn -ar 44100 -ac 2 -b:a 128k bg.mp3
                  ffmpeg -y -i clips_short/short.mp4 -i bg.mp3 -shortest -c:v copy -c:a aac -b:a 128k clips_short/short_with_audio.mp4
                  mv clips_short/short_with_audio.mp4 clips_short/short.mp4
                fi
              fi
            fi
          fi

          # fallback to Mixkit link if still no audio
          if ! ffmpeg -i clips_short/short.mp4 -af "volumedetect" -f null /dev/null 2>&1 | grep -q "mean_volume"; then
            FALLBACK="${MIXKIT_FALLBACK_AUDIO:-https://assets.mixkit.co/music/preview/mixkit-relaxing-piano-628.mp3}"
            curl -L -o bg.mp3 "$FALLBACK" || true
            ffmpeg -y -i clips_short/short.mp4 -i bg.mp3 -shortest -c:v copy -c:a aac -b:a 128k clips_short/short_with_audio.mp4
            mv clips_short/short_with_audio.mp4 clips_short/short.mp4
          fi

      - name: Get YouTube access token
        id: token
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
        run: |
          resp=$(curl -s -d client_id="$GOOGLE_CLIENT_ID" -d client_secret="$GOOGLE_CLIENT_SECRET" -d refresh_token="$YT_REFRESH_TOKEN" -d grant_type=refresh_token https://oauth2.googleapis.com/token)
          ACCESS=$(echo "$resp" | jq -r .access_token)
          if [ -z "$ACCESS" ] || [ "$ACCESS" = "null" ]; then echo "Failed to get access token"; echo "$resp"; exit 1; fi
          echo "access=$ACCESS" >> $GITHUB_OUTPUT

      - name: Upload short (resumable) - will be treated as Short by YouTube if < 60s
        env:
          ACCESS_TOKEN: ${{ steps.token.outputs.access }}
        run: |
          TITLE_OPTIONS=("Short: Rain for Sleep ðŸŒ§ï¸" "Short: Ocean Calm ðŸŒŠ" "Short: Forest Breath ðŸƒ" "Short: Gentle Waterfall ðŸ’§")
          TITLE="${TITLE_OPTIONS[$RANDOM % ${#TITLE_OPTIONS[@]}]}"
          DESCRIPTION="Short relaxing clip â€” perfect for a calm moment. #shorts #relaxing #nature"
          jq -n --arg t "$TITLE" --arg d "$DESCRIPTION" '{"snippet":{"title":$t,"description":$d,"tags":["shorts","relaxing","nature"],"categoryId":"22"},"status":{"privacyStatus":"public"}}' > meta.json || true
          cat > meta.json <<EOF
{"snippet":{"title":"$TITLE","description":"$DESCRIPTION","tags":["shorts","relaxing","nature"],"categoryId":"22"},"status":{"privacyStatus":"public"}}
EOF
          curl -s -D headers.txt -o body.txt -X POST "https://www.googleapis.com/upload/youtube/v3/videos?uploadType=resumable&part=snippet,status" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json; charset=UTF-8" \
            -d @meta.json
          UPLOAD_URL=$(grep -i '^Location:' headers.txt | awk '{print $2}' | tr -d '\r\n')
          if [ -z "$UPLOAD_URL" ]; then echo "No upload URL"; cat headers.txt; exit 1; fi
          curl -s -X PUT -T clips_short/short.mp4 -H "Content-Type: application/octet-stream" "$UPLOAD_URL" -o result.json
          cat result.json
